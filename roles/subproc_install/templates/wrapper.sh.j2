#!/bin/bash -e

SCRIPT_VENV={{ subproc_venv_dir }}

# hack to get subproc's pkg version
if [ ${1} == 'version_only' ]
then
    if [ "$#" -eq 2 ]
    then
        SCRIPT_VERSION=$($SCRIPT_VENV/bin/pip show $2 | grep 'Version' | cut -d ' ' -f 2)
    fi
    echo $SCRIPT_VERSION
    exit 0
fi

input_file=${1}
input_dir=$(dirname ${1})
input_id=$(basename ${input_dir})  # assumes input file has a unique parent dir

echo "***** untar/ungzip input file ${input_file}"
# untar uploaded file
tar xf ${input_file} -C ${input_dir}

echo
echo "***** about to process input file ${input_file}"

# run hx_util script
${SCRIPT_VENV}/bin/hx_util ${input_dir}/course

echo "***** done with hx_util, next olxcleaner for ${input_dir}"
echo

# run olxcleaner script
${SCRIPT_VENV}/bin/edx-report -c ${input_dir}/course/course.xml > ${input_dir}/latexfile.tex

result_dir=${input_dir}/result_${input_id}
mkdir -p ${result_dir}

echo "***** copying output files to ${result_dir}"
echo

# move result to known locaton
cp ${input_dir}/course/*.tsv ${result_dir}
cp ${input_dir}/*.zip ${result_dir}
cp ${input_dir}/latexfile.tex ${result_dir}

echo "***** generating tar.gz"
echo

cd ${input_dir}
tar cvzf ${input_dir}/result.tar.gz result_${input_id}

echo "***** all done"

